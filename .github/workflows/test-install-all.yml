name: Test Software Installation Script

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl git apt-transport-https gnupg2 ca-certificates lsb-release
          # Ensure commands are in PATH
          export PATH="/usr/bin:/bin:/usr/sbin:/sbin:$PATH"
          which wget || echo "wget not found"
          which curl || echo "curl not found"
          
      # Skip snap-based installations in CI (Microk8s, AzureStorageExplorer)
      # Skip installations that require heavy downloads or complex setup (GO, nvm, k9s)
      
      - name: Run installation script with selected software
        run: |
          cd bin
          # Export PATH to ensure commands are available
          ./install_softwares.sh -ax Spotify 
        env:
          CI: true
          # PATH: /usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin

      - name: Verify installations
        run: |
          echo "Verifying installed software..."
          command -v kubectl && echo "✅ kubectl installed" || echo "❌ kubectl not found"
          command -v code && echo "✅ VSCode installed" || echo "❌ VSCode not found"  
          command -v docker && echo "✅ Docker installed" || echo "❌ Docker not found"
          command -v kind && echo "✅ kind installed" || echo "❌ kind not found"
          command -v kustomize && echo "✅ kustomize installed" || echo "❌ kustomize not found"
          command -v sqlite3 && echo "✅ SQLite CLI installed" || echo "❌ SQLite CLI not found"
          command -v node && echo "✅ Node.js installed" || echo "❌ Node.js not found"

      - name: Verify installed versions
        run: |
          echo "=== Installed Versions ==="
          printf "kubectl: " && (kubectl version --client 2>/dev/null | head -1 || echo "N/A")
          printf "VSCode: " && (code --version 2>/dev/null | head -1 || echo "N/A")
          printf "Docker: " && (docker --version 2>/dev/null || echo "N/A")
          printf "kind: " && (kind version 2>/dev/null || echo "N/A")
          printf "kustomize: " && (kustomize version --short 2>/dev/null || echo "N/A")
          printf "SQLite CLI: " && (sqlite3 --version 2>/dev/null || echo "N/A")
          printf "Node.js: " && (node --version 2>/dev/null || echo "N/A")
          printf "npm: " && (npm --version 2>/dev/null || echo "N/A")

      # - name: Check logs for errors
      #   if: always()
      #   run: |
      #     if [ -f bin/logs.log ]; then
      #       echo "=== Installation Logs ==="
      #       cat bin/logs.log
      #     fi
