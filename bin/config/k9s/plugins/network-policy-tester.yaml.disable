shortCut: Shift-Q
description: Network Policy Tester
dangerous: false
scopes:
  - pods
  - networkpolicies
  - namespaces
command: bash
background: false
confirm: false
args:
  - -c
  - |
    # Colors
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    MAGENTA='\033[0;35m'
    CYAN='\033[0;36m'
    BOLD='\033[1m'
    DIM='\033[2m'
    NC='\033[0m'
    
    # Cleanup function
    cleanup() {
      rm -f /tmp/netpol-*.json 2>/dev/null
    }
    trap cleanup EXIT
    
    clear
    echo -e "${BOLD}${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}${BLUE}â•‘     Network Policy Tester v1.0        â•‘${NC}"
    echo -e "${BOLD}${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    # Context detection
    POD_NAME=""
    POLICY_NAME=""
    NS=""
    MODE=""
    
    if [[ "$RESOURCE_NAME" == "pods" && -n "$NAME" ]]; then
      MODE="pod"
      POD_NAME="$NAME"
      NS="$NAMESPACE"
      echo -e "ðŸ“¦ Testing from pod: ${CYAN}${BOLD}$POD_NAME${NC} in namespace ${CYAN}${BOLD}$NS${NC}"
    elif [[ "$RESOURCE_NAME" == "networkpolicies" && -n "$NAME" ]]; then
      MODE="policy"
      POLICY_NAME="$NAME"
      NS="$NAMESPACE"
      echo -e "ðŸ”’ Analyzing policy: ${CYAN}${BOLD}$POLICY_NAME${NC} in namespace ${CYAN}${BOLD}$NS${NC}"
    elif [[ "$RESOURCE_NAME" == "namespaces" && -n "$NAME" ]]; then
      MODE="namespace"
      NS="$NAME"
      echo -e "ðŸŒ Testing namespace: ${CYAN}${BOLD}$NS${NC}"
    else
      echo -e "${RED}âœ— Error: Unknown resource type${NC}"
      read -n 1 -s -r -p "Press any key to exit..."
      exit 1
    fi
    echo ""
    
    # Check prerequisites
    if ! command -v jq &> /dev/null; then
      echo -e "${RED}âœ— Error: jq is not installed${NC}"
      echo -e "${DIM}Install with: apt-get install jq / brew install jq${NC}"
      read -n 1 -s -r -p "Press any key to exit..."
      exit 1
    fi
    
    # ============================================
    # FUNCTION: Get pod labels
    # ============================================
    get_pod_labels() {
      local pod=$1
      local namespace=$2
      kubectl get pod "$pod" -n "$namespace" -o json 2>/dev/null | \
        jq -r '.metadata.labels // {} | to_entries | map("\(.key)=\(.value)") | join(",")'
    }
    
    # ============================================
    # FUNCTION: Check if selector matches labels
    # ============================================
    selector_matches() {
      local selector=$1
      local labels=$2
      
      # Empty selector matches all pods
      if [[ "$selector" == "{}" || "$selector" == "null" ]]; then
        echo "true"
        return
      fi
      
      # Parse selector and check each label
      local match="true"
      while IFS='=' read -r key value; do
        if [[ -n "$key" && -n "$value" ]]; then
          if [[ "$labels" != *"$key=$value"* ]]; then
            match="false"
            break
          fi
        fi
      done < <(echo "$selector" | jq -r 'to_entries[] | "\(.key)=\(.value)"' 2>/dev/null)
      
      echo "$match"
    }
    
    # ============================================
    # FUNCTION: Find policies affecting a pod
    # ============================================
    find_policies_for_pod() {
      local pod=$1
      local namespace=$2
      
      echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      echo -e "${BOLD}ðŸ“‹ NetworkPolicies Affecting This Pod${NC}"
      echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      
      local pod_labels=$(get_pod_labels "$pod" "$namespace")
      
      if [[ -z "$pod_labels" ]]; then
        echo -e "${RED}âœ— Could not get pod labels${NC}"
        return
      fi
      
      echo -e "${DIM}Pod labels: $pod_labels${NC}"
      echo ""
      
      # Get all policies in namespace
      local policies=$(kubectl get networkpolicies -n "$namespace" -o json 2>/dev/null)
      
      if [[ -z "$policies" ]]; then
        echo -e "${YELLOW}âš  No NetworkPolicies found in namespace${NC}"
        echo -e "${DIM}This pod has unrestricted network access${NC}"
        return
      fi
      
      local policy_count=$(echo "$policies" | jq -r '.items | length')
      
      if [[ "$policy_count" -eq 0 ]]; then
        echo -e "${YELLOW}âš  No NetworkPolicies found in namespace${NC}"
        echo -e "${DIM}This pod has unrestricted network access${NC}"
        return
      fi
      
      local found=0
      
      # Check each policy
      while IFS=$'\t' read -r name selector; do
        if [[ -z "$name" ]]; then
          continue
        fi
        
        local matches=$(selector_matches "$selector" "$pod_labels")
        
        if [[ "$matches" == "true" ]]; then
          found=$((found + 1))
          echo -e "${GREEN}âœ“${NC} ${BOLD}$name${NC}"
          
          # Get policy types
          local policy_types=$(echo "$policies" | jq -r --arg name "$name" \
            '.items[] | select(.metadata.name == $name) | .spec.policyTypes // ["Ingress"] | join(", ")')
          echo -e "  ${DIM}Policy Types: $policy_types${NC}"
          
          # Show selector
          if [[ "$selector" == "{}" || "$selector" == "null" ]]; then
            echo -e "  ${DIM}Selector: {} (matches all pods)${NC}"
          else
            echo -e "  ${DIM}Selector: $selector${NC}"
          fi
          echo ""
        fi
      done < <(echo "$policies" | jq -r '.items[] | [.metadata.name, (.spec.podSelector.matchLabels // {})] | @tsv')
      
      if [[ $found -eq 0 ]]; then
        echo -e "${YELLOW}âš  No policies match this pod${NC}"
        echo -e "${DIM}Pod has unrestricted network access${NC}"
      else
        echo -e "${BLUE}Total matching policies: $found${NC}"
      fi
    }
    
    # ============================================
    # FUNCTION: Display policy details
    # ============================================
    display_policy_details() {
      local policy=$1
      local namespace=$2
      
      echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      echo -e "${BOLD}ðŸ” Policy Details${NC}"
      echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      
      local policy_json=$(kubectl get networkpolicy "$policy" -n "$namespace" -o json 2>/dev/null)
      
      if [[ -z "$policy_json" ]]; then
        echo -e "${RED}âœ— Could not get policy details${NC}"
        return
      fi
      
      # Pod Selector
      echo -e "${CYAN}${BOLD}Pod Selector:${NC}"
      local selector=$(echo "$policy_json" | jq -r '.spec.podSelector.matchLabels // {}')
      if [[ "$selector" == "{}" || "$selector" == "null" ]]; then
        echo -e "  ${DIM}{} (matches all pods in namespace)${NC}"
      else
        echo "$policy_json" | jq -r '.spec.podSelector.matchLabels // {} | to_entries[] | "  \(.key): \(.value)"'
      fi
      echo ""
      
      # Policy Types
      echo -e "${CYAN}${BOLD}Policy Types:${NC}"
      echo "$policy_json" | jq -r '.spec.policyTypes[]? // "Ingress" | "  â€¢ \(.)"'
      echo ""
      
      # Ingress Rules
      local ingress_count=$(echo "$policy_json" | jq '.spec.ingress // [] | length')
      echo -e "${CYAN}${BOLD}Ingress Rules:${NC} ${DIM}($ingress_count rules)${NC}"
      
      if [[ $ingress_count -eq 0 ]]; then
        local has_ingress=$(echo "$policy_json" | jq -r '.spec.policyTypes[]? | select(. == "Ingress")')
        if [[ -n "$has_ingress" ]]; then
          echo -e "  ${RED}âœ— No ingress allowed (deny all)${NC}"
        else
          echo -e "  ${DIM}Not specified (default allow)${NC}"
        fi
      else
        echo "$policy_json" | jq -r '
          .spec.ingress[]? | 
          "  ${GREEN}Rule:${NC}" as $header |
          (
            if .from then
              .from[] | 
              if .podSelector then
                "    From pods: \(.podSelector.matchLabels // {} | to_entries | map("\(.key)=\(.value)") | join(", ") // "any")"
              elif .namespaceSelector then
                "    From namespaces: \(.namespaceSelector.matchLabels // {} | to_entries | map("\(.key)=\(.value)") | join(", ") // "any")"
              elif .ipBlock then
                "    From IPs: \(.ipBlock.cidr)"
              else
                "    From: any"
              end
            else
              "    From: any (in namespace)"
            end
          ) as $from |
          (
            if .ports then
              .ports[] | "    Port: \(.port // "any")/\(.protocol // "TCP")"
            else
              "    Ports: any"
            end
          ) as $ports |
          [$header, $from, $ports] | join("\n")
        ' | head -20
        
        if [[ $ingress_count -gt 5 ]]; then
          echo -e "  ${DIM}... (showing first 5 rules)${NC}"
        fi
      fi
      echo ""
      
      # Egress Rules
      local egress_count=$(echo "$policy_json" | jq '.spec.egress // [] | length')
      echo -e "${CYAN}${BOLD}Egress Rules:${NC} ${DIM}($egress_count rules)${NC}"
      
      if [[ $egress_count -eq 0 ]]; then
        local has_egress=$(echo "$policy_json" | jq -r '.spec.policyTypes[]? | select(. == "Egress")')
        if [[ -n "$has_egress" ]]; then
          echo -e "  ${RED}âœ— No egress allowed (deny all)${NC}"
        else
          echo -e "  ${DIM}Not specified (default allow)${NC}"
        fi
      else
        echo "$policy_json" | jq -r '
          .spec.egress[]? | 
          "  ${GREEN}Rule:${NC}" as $header |
          (
            if .to then
              .to[] | 
              if .podSelector then
                "    To pods: \(.podSelector.matchLabels // {} | to_entries | map("\(.key)=\(.value)") | join(", ") // "any")"
              elif .namespaceSelector then
                "    To namespaces: \(.namespaceSelector.matchLabels // {} | to_entries | map("\(.key)=\(.value)") | join(", ") // "any")"
              elif .ipBlock then
                "    To IPs: \(.ipBlock.cidr)"
              else
                "    To: any"
              end
            else
              "    To: any"
            end
          ) as $to |
          (
            if .ports then
              .ports[] | "    Port: \(.port // "any")/\(.protocol // "TCP")"
            else
              "    Ports: any"
            end
          ) as $ports |
          [$header, $to, $ports] | join("\n")
        ' | head -20
        
        if [[ $egress_count -gt 5 ]]; then
          echo -e "  ${DIM}... (showing first 5 rules)${NC}"
        fi
      fi
    }
    
    # ============================================
    # FUNCTION: Test connectivity
    # ============================================
    test_connectivity() {
      local pod=$1
      local namespace=$2
      
      echo ""
      echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      echo -e "${BOLD}ðŸ”Œ Connectivity Tests${NC}"
      echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      
      echo -e "${DIM}Testing common services from this pod...${NC}"
      echo ""
      
      # Test DNS
      echo -n "DNS (kube-dns.kube-system:53): "
      if kubectl exec -n "$namespace" "$pod" -- timeout 2 sh -c 'nc -zv kube-dns.kube-system 53' &>/dev/null 2>&1; then
        echo -e "${GREEN}âœ“ Reachable${NC}"
      else
        # Try with nslookup as fallback
        if kubectl exec -n "$namespace" "$pod" -- timeout 2 nslookup kubernetes.default &>/dev/null 2>&1; then
          echo -e "${GREEN}âœ“ Reachable${NC}"
        else
          echo -e "${RED}âœ— Blocked${NC}"
        fi
      fi
      
      # Test Kubernetes API
      echo -n "Kubernetes API (kubernetes.default:443): "
      if kubectl exec -n "$namespace" "$pod" -- timeout 2 sh -c 'nc -zv kubernetes.default 443' &>/dev/null 2>&1; then
        echo -e "${GREEN}âœ“ Reachable${NC}"
      else
        echo -e "${RED}âœ— Blocked${NC}"
      fi
      
      # Test other pods in same namespace
      echo ""
      echo -e "${DIM}Testing connectivity to other pods in namespace...${NC}"
      
      local other_pods=$(kubectl get pods -n "$namespace" --no-headers -o custom-columns=":metadata.name" | grep -v "^$pod$" | head -3)
      
      if [[ -n "$other_pods" ]]; then
        while read -r target_pod; do
          if [[ -z "$target_pod" ]]; then
            continue
          fi
          
          local target_ip=$(kubectl get pod "$target_pod" -n "$namespace" -o jsonpath='{.status.podIP}' 2>/dev/null)
          
          if [[ -n "$target_ip" ]]; then
            echo -n "Pod $target_pod ($target_ip): "
            if kubectl exec -n "$namespace" "$pod" -- timeout 2 sh -c "nc -zv $target_ip 80" &>/dev/null 2>&1; then
              echo -e "${GREEN}âœ“ Reachable${NC}"
            else
              # Try ping as fallback
              if kubectl exec -n "$namespace" "$pod" -- timeout 2 ping -c 1 "$target_ip" &>/dev/null 2>&1; then
                echo -e "${GREEN}âœ“ Reachable${NC} ${DIM}(ICMP)${NC}"
              else
                echo -e "${YELLOW}? Unknown${NC} ${DIM}(no listener on port 80)${NC}"
              fi
            fi
          fi
        done <<< "$other_pods"
      else
        echo -e "${DIM}No other pods found in namespace${NC}"
      fi
      
      # Test external connectivity
      echo ""
      echo -n "External (8.8.8.8): "
      if kubectl exec -n "$namespace" "$pod" -- timeout 2 ping -c 1 8.8.8.8 &>/dev/null 2>&1; then
        echo -e "${GREEN}âœ“ Reachable${NC}"
      else
        echo -e "${RED}âœ— Blocked${NC}"
      fi
      
      echo ""
      echo -e "${DIM}Note: Tests use timeout 2s. False negatives possible if services don't exist.${NC}"
    }
    
    # ============================================
    # FUNCTION: Suggest policies
    # ============================================
    suggest_policies() {
      local namespace=$1
      
      echo ""
      echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      echo -e "${BOLD}ðŸ’¡ Policy Suggestions${NC}"
      echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      
      local total_pods=$(kubectl get pods -n "$namespace" --no-headers 2>/dev/null | wc -l)
      local policies=$(kubectl get networkpolicies -n "$namespace" -o json 2>/dev/null)
      local policy_count=$(echo "$policies" | jq -r '.items | length' 2>/dev/null || echo "0")
      
      echo -e "Namespace: ${CYAN}$namespace${NC}"
      echo -e "Total pods: ${CYAN}$total_pods${NC}"
      echo -e "Total policies: ${CYAN}$policy_count${NC}"
      echo ""
      
      if [[ $policy_count -eq 0 ]]; then
        echo -e "${YELLOW}âš  No NetworkPolicies found${NC}"
        echo ""
        echo -e "${BOLD}Recommendations:${NC}"
        echo -e "  ${GREEN}1.${NC} Create a default deny policy:"
        echo -e "     ${DIM}Blocks all ingress/egress by default${NC}"
        echo -e "  ${GREEN}2.${NC} Add allow DNS policy:"
        echo -e "     ${DIM}Allow egress to kube-dns (UDP 53)${NC}"
        echo -e "  ${GREEN}3.${NC} Add allow within namespace policy:"
        echo -e "     ${DIM}Allow pods to communicate within namespace${NC}"
        return
      fi
      
      # Check for common missing policies
      local has_dns_policy=$(echo "$policies" | jq -r '.items[] | select(.spec.egress[]?.to[]?.namespaceSelector?.matchLabels?."kubernetes.io/metadata.name" == "kube-system") | .metadata.name' | head -1)
      
      local has_default_deny=$(echo "$policies" | jq -r '.items[] | select(.spec.podSelector.matchLabels == null or .spec.podSelector.matchLabels == {}) | select(.spec.policyTypes[]? == "Ingress" or .spec.policyTypes[]? == "Egress") | select(.spec.ingress == null or .spec.ingress == []) | .metadata.name' | head -1)
      
      echo -e "${BOLD}Analysis:${NC}"
      
      if [[ -z "$has_default_deny" ]]; then
        echo -e "  ${YELLOW}âš ${NC} No default-deny policy found"
        echo -e "    ${DIM}Consider creating a baseline deny-all policy${NC}"
      else
        echo -e "  ${GREEN}âœ“${NC} Default-deny policy exists: ${BOLD}$has_default_deny${NC}"
      fi
      
      if [[ -z "$has_dns_policy" ]]; then
        echo -e "  ${YELLOW}âš ${NC} No explicit DNS egress policy found"
        echo -e "    ${DIM}Pods might not be able to resolve DNS${NC}"
      else
        echo -e "  ${GREEN}âœ“${NC} DNS policy exists"
      fi
      
      # Check for pods without any matching policy
      echo ""
      echo -e "${BOLD}Unprotected Pods:${NC}"
      local unprotected=0
      
      while read -r pod; do
        if [[ -z "$pod" ]]; then
          continue
        fi
        
        local pod_labels=$(get_pod_labels "$pod" "$namespace")
        local has_policy=false
        
        while IFS=$'\t' read -r name selector; do
          if [[ -z "$name" ]]; then
            continue
          fi
          
          local matches=$(selector_matches "$selector" "$pod_labels")
          if [[ "$matches" == "true" ]]; then
            has_policy=true
            break
          fi
        done < <(echo "$policies" | jq -r '.items[] | [.metadata.name, (.spec.podSelector.matchLabels // {})] | @tsv')
        
        if [[ "$has_policy" == "false" ]]; then
          echo -e "  ${YELLOW}â€¢${NC} $pod ${DIM}(no policies match)${NC}"
          unprotected=$((unprotected + 1))
        fi
      done < <(kubectl get pods -n "$namespace" --no-headers -o custom-columns=":metadata.name" 2>/dev/null)
      
      if [[ $unprotected -eq 0 ]]; then
        echo -e "  ${GREEN}âœ“${NC} All pods are covered by at least one policy"
      else
        echo -e "  ${DIM}Total: $unprotected unprotected pods${NC}"
      fi
    }
    
    # ============================================
    # FUNCTION: Show namespace policies
    # ============================================
    show_namespace_policies() {
      local namespace=$1
      
      echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      echo -e "${BOLD}ðŸ“‹ All NetworkPolicies in Namespace${NC}"
      echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      
      local policies=$(kubectl get networkpolicies -n "$namespace" -o json 2>/dev/null)
      local policy_count=$(echo "$policies" | jq -r '.items | length' 2>/dev/null || echo "0")
      
      if [[ $policy_count -eq 0 ]]; then
        echo -e "${YELLOW}âš  No NetworkPolicies found${NC}"
        return
      fi
      
      echo -e "${CYAN}Found $policy_count policies${NC}"
      echo ""
      
      while IFS=$'\t' read -r name types selector; do
        if [[ -z "$name" ]]; then
          continue
        fi
        
        echo -e "${GREEN}â€¢${NC} ${BOLD}$name${NC}"
        echo -e "  Types: ${DIM}$types${NC}"
        
        if [[ "$selector" == "{}" || "$selector" == "null" ]]; then
          echo -e "  Selector: ${DIM}{} (all pods)${NC}"
        else
          echo -e "  Selector: ${DIM}$selector${NC}"
        fi
        echo ""
      done < <(echo "$policies" | jq -r '.items[] | [.metadata.name, (.spec.policyTypes // ["Ingress"] | join(", ")), (.spec.podSelector.matchLabels // {})] | @tsv')
    }
    
    # ============================================
    # MAIN EXECUTION
    # ============================================
    
    case "$MODE" in
      pod)
        find_policies_for_pod "$POD_NAME" "$NS"
        test_connectivity "$POD_NAME" "$NS"
        suggest_policies "$NS"
        ;;
      
      policy)
        display_policy_details "$POLICY_NAME" "$NS"
        ;;
      
      namespace)
        show_namespace_policies "$NS"
        suggest_policies "$NS"
        ;;
    esac
    
    echo ""
    echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    read -n 1 -s -r -p "Press any key to exit..."
