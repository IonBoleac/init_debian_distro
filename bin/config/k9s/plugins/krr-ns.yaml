# KRR for namespaces
# first install krr from: https://github.com/IonBoleac/krr
shortCut: Shift-K
description: Get krr
scopes:
  - namespaces
command: bash
background: false
confirm: false
args:
    - -c
    - |
      # Colors first (before any output)
      RED='\033[0;31m'
      GREEN='\033[0;32m'
      YELLOW='\033[1;33m'
      NC='\033[0m'

      echo -e "${GREEN}========================================${NC}"
      echo -e "${GREEN}KRR for Namespace${NC}"
      echo -e "${GREEN}========================================${NC}"
      echo ""
      
      # Fix K9S_HOME if empty
      if [ -z "$K9S_HOME" ]; then
          K9S_HOME="$HOME/.config/k9s"
      fi

      ENV_FILE="$K9S_HOME/plugins/.env"
      
      if [ ! -f "$ENV_FILE" ]; then
          echo -e "${RED}ERROR: Missing .env file${NC}"
          echo "Expected: $ENV_FILE"
          echo ""
          read -n 1 -s -r -p "Press any key to exit..."
          exit 1
      fi

      # KRR fork script location
      KRR_SCRIPT="$HOME/krr-fork/krr.py"

      echo -e "${YELLOW}Loading configuration from .env...${NC}"
      set -a
      source "$ENV_FILE"
      set +a

      # Auto-detect cluster type and extract info from context
      # Context formats:
      # - Anthos: connectgateway_PROJECT_LOCATION_CLUSTERNAME
      # - GKE: gke_PROJECT_LOCATION_CLUSTERNAME
      
      if [[ "$CONTEXT" == connectgateway_* ]]; then
          # Anthos cluster
          USE_ANTHOS="anthos"
          # Extract from connectgateway_PROJECT_LOCATION_CLUSTERNAME
          DETECTED_PROJECT=$(echo "$CONTEXT" | cut -d'_' -f2)
          DETECTED_CLUSTER=$(echo "$CONTEXT" | cut -d'_' -f4)
          CLUSTER_TYPE="Anthos"
      elif [[ "$CONTEXT" == gke_* ]]; then
          # GKE cluster
          USE_ANTHOS=""
          # Extract from gke_PROJECT_LOCATION_CLUSTERNAME
          DETECTED_PROJECT=$(echo "$CONTEXT" | cut -d'_' -f2)
          DETECTED_CLUSTER=$(echo "$CONTEXT" | cut -d'_' -f4)
          CLUSTER_TYPE="GKE"
      else
          # Unknown format - use .env defaults
          DETECTED_PROJECT="${PROJECT_ID}"
          DETECTED_CLUSTER="${CLUSTER_NAME}"
          CLUSTER_TYPE="Unknown"
          echo -e "${YELLOW}Warning: Unknown context format, using .env defaults${NC}"
      fi
      
      # Override with detected values (or keep .env if detection failed)
      PROJECT_ID="${DETECTED_PROJECT:-$PROJECT_ID}"
      CLUSTER_NAME="${DETECTED_CLUSTER:-$CLUSTER_NAME}"

      # In namespaces view, use $NAME as the target namespace
      TARGET_NAMESPACE="$NAME"

      # Set defaults if not defined in .env
      HISTORY_DURATION="${HISTORY_DURATION:-300}"
      TIMEFRAME_DURATION="${TIMEFRAME_DURATION:-1.25}"
      LOCATION="${LOCATION:-global}"
      CPU_PERCENTILE="${CPU_PERCENTILE:-95}"
      
      echo -e "${YELLOW}Configuration (after override):${NC}"
      echo "  PROJECT_ID: ${PROJECT_ID}"
      echo "  CLUSTER_NAME: ${CLUSTER_NAME}"
      echo "  TARGET_NAMESPACE: ${TARGET_NAMESPACE}"
      echo "  CONTEXT: ${CONTEXT}"
      echo "  USE_ANTHOS: ${USE_ANTHOS}"
      echo "  CPU_PERCENTILE: ${CPU_PERCENTILE}"
      echo ""

      if [ -z "${PROJECT_ID:-}" ] || [ -z "${CLUSTER_NAME:-}" ]; then
          echo -e "${RED}ERROR: Could not detect PROJECT_ID and CLUSTER_NAME from context${NC}"
          echo "Context: $CONTEXT"
          echo "Please check your .env file or context format"
          echo ""
          read -n 1 -s -r -p "Press any key to exit..."
          exit 1
      fi

      # Get token
      TOKEN=$(gcloud auth print-access-token 2>/dev/null)

      if [ -z "$TOKEN" ]; then
          echo -e "${RED}ERROR: Cannot get GCP token${NC}"
          echo "Run: gcloud auth login"
          echo ""
          read -n 1 -s -r -p "Press any key to exit..."
          exit 1
      fi

      # Verify Python
      PYTHON_CMD="python"

      # Venv activation
      if [ -f "/home/ciuon/krr-fork/venv/bin/activate" ]; then
          echo -e "${YELLOW}Activating KRR virtual environment...${NC}"
          # shellcheck disable=SC1090
          source "/home/ciuon/krr-fork/venv/bin/activate"
      else
          echo -e "${YELLOW}No virtual environment found, using system Python...${NC}"
      fi

      # Prometheus URL
      PROMETHEUS_URL="https://monitoring.googleapis.com/v1/projects/${PROJECT_ID}/location/${LOCATION}/prometheus"

      # Build Anthos flag
      ANTHOS_FLAG=""
      if [ "$USE_ANTHOS" = "anthos" ]; then
          ANTHOS_FLAG="--gcp-anthos"
      fi

      # Run KRR analysis
      $PYTHON_CMD "$KRR_SCRIPT" simple \
        --context="${CONTEXT}" \
        --prometheus-url="${PROMETHEUS_URL}" \
        --prometheus-auth-header="Bearer ${TOKEN}" \
        --prometheus-cluster-label="${CLUSTER_NAME}" \
        --prometheus-label="cluster_name" \
        --namespace="${TARGET_NAMESPACE}" \
        --history-duration="${HISTORY_DURATION}" \
        --timeframe-duration="${TIMEFRAME_DURATION}" \
        --cpu-percentile="${CPU_PERCENTILE}" \
        --memory-buffer-percentage=15 \
        $ANTHOS_FLAG 
        # --show-cluster-name
        
      EXIT_CODE=$?

      echo ""
      if [ $EXIT_CODE -eq 0 ]; then
          echo -e "${GREEN}✓ Analysis completed${NC}"
      else
          echo -e "${RED}✗ Analysis failed (exit code: ${EXIT_CODE})${NC}"
      fi
      echo ""

      read -n 1 -s -r -p "Press any key to exit..."
